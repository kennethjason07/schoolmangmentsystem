<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test School Onboarding System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ School Onboarding System Test</h1>
        <p>This page tests the complete school onboarding flow including tenant creation and admin user setup.</p>
        
        <!-- Database Connection Test -->
        <div class="test-section">
            <h3>1. Database Connection Test</h3>
            <p>Test if we can connect to Supabase and access the tenants table.</p>
            <button class="test-button" onclick="testDatabaseConnection()">Test Connection</button>
            <div id="dbTestResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Subdomain Availability Test -->
        <div class="test-section">
            <h3>2. Subdomain Availability Test</h3>
            <p>Test subdomain availability checking functionality.</p>
            <input type="text" id="testSubdomain" placeholder="Enter subdomain to test" style="padding: 8px; margin-right: 10px;">
            <button class="test-button" onclick="testSubdomainAvailability()">Check Availability</button>
            <div id="subdomainTestResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Tenant Creation Test -->
        <div class="test-section">
            <h3>3. Tenant Creation Test</h3>
            <p>Create a test tenant with sample data.</p>
            <button class="test-button" onclick="testTenantCreation()">Create Test Tenant</button>
            <button class="test-button" onclick="clearTestData()" style="background: #dc3545;">Clear Test Data</button>
            <div id="tenantTestResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Admin User Creation Test -->
        <div class="test-section">
            <h3>4. Admin User Creation Test</h3>
            <p>Create a test admin user for the latest tenant.</p>
            <button class="test-button" onclick="testAdminUserCreation()">Create Test Admin</button>
            <div id="adminTestResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Complete Onboarding Flow Test -->
        <div class="test-section">
            <h3>5. Complete Onboarding Flow Test</h3>
            <p>Test the complete end-to-end onboarding process.</p>
            <button class="test-button" onclick="testCompleteOnboarding()">Test Complete Flow</button>
            <div id="completeTestResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Multi-tenant Isolation Test -->
        <div class="test-section">
            <h3>6. Multi-tenant Isolation Test</h3>
            <p>Test that data is properly isolated between tenants.</p>
            <button class="test-button" onclick="testMultiTenantIsolation()">Test Isolation</button>
            <div id="isolationTestResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Supabase Configuration -->
    <script src="supabase-config.js"></script>
    
    <!-- Test Scripts -->
    <script>
        let testTenantId = null;
        let testAdminUserId = null;

        // Test 1: Database Connection
        async function testDatabaseConnection() {
            const resultDiv = document.getElementById('dbTestResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'Testing database connection...';

            try {
                const supabase = getSupabaseClient();
                
                // Test basic query to tenants table
                const { data, error } = await supabase
                    .from('tenants')
                    .select('id, name, subdomain')
                    .limit(5);

                if (error) {
                    throw error;
                }

                resultDiv.className = 'test-result success';
                resultDiv.textContent = `‚úÖ Database connection successful!
Found ${data.length} existing tenants:
${data.map(t => `- ${t.name} (${t.subdomain})`).join('\\n')}`;

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Database connection failed:
${error.message}`;
                console.error('Database test error:', error);
            }
        }

        // Test 2: Subdomain Availability
        async function testSubdomainAvailability() {
            const subdomain = document.getElementById('testSubdomain').value.trim();
            const resultDiv = document.getElementById('subdomainTestResult');
            
            if (!subdomain) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Please enter a subdomain to test';
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result info';
            resultDiv.textContent = `Testing subdomain availability for: ${subdomain}...`;

            try {
                const tenantService = new window.TenantService();
                const isAvailable = await tenantService.checkSubdomainAvailability(subdomain);

                resultDiv.className = 'test-result success';
                resultDiv.textContent = `‚úÖ Subdomain check completed:
Subdomain "${subdomain}" is ${isAvailable ? 'AVAILABLE' : 'TAKEN'}`;

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Subdomain check failed:
${error.message}`;
                console.error('Subdomain test error:', error);
            }
        }

        // Test 3: Tenant Creation
        async function testTenantCreation() {
            const resultDiv = document.getElementById('tenantTestResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'Creating test tenant...';

            try {
                const testSubdomain = 'testschool' + Date.now();
                const tenantService = new window.TenantService();

                const tenantData = {
                    name: 'Test School ' + Date.now(),
                    subdomain: testSubdomain,
                    contact_email: 'admin@testschool.com',
                    contact_phone: '+1-555-123-4567',
                    address: '123 Test Street, Test City, TC 12345',
                    subscription_plan: 'standard',
                    timezone: 'Asia/Kolkata',
                    max_students: 500,
                    max_teachers: 50,
                    max_classes: 20,
                    academic_year_start_month: 4,
                    features: {
                        fees: true,
                        exams: true,
                        messaging: true,
                        attendance: true
                    }
                };

                const result = await tenantService.registerTenant(tenantData);

                if (result.success) {
                    testTenantId = result.tenantId;
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `‚úÖ Test tenant created successfully!
Tenant ID: ${result.tenantId}
Name: ${result.data.name}
Subdomain: ${result.data.subdomain}
Created: ${result.data.created_at}`;
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Tenant creation failed:
${error.message}`;
                console.error('Tenant creation test error:', error);
            }
        }

        // Test 4: Admin User Creation
        async function testAdminUserCreation() {
            const resultDiv = document.getElementById('adminTestResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'Creating test admin user...';

            if (!testTenantId) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå No test tenant available. Please create a test tenant first.';
                return;
            }

            try {
                const adminService = new AdminUserService();
                const timestamp = Date.now();

                const adminData = {
                    email: `admin${timestamp}@testschool.com`,
                    password: 'TestPassword123!',
                    full_name: 'Test Administrator',
                    phone: '+1-555-987-6543',
                    tenant_id: testTenantId
                };

                const result = await adminService.createAdminUser(adminData);

                if (result.success) {
                    testAdminUserId = result.data.userRecord.id;
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `‚úÖ Test admin user created successfully!
User ID: ${result.data.userRecord.id}
Email: ${result.data.userRecord.email}
Full Name: ${result.data.userRecord.full_name}
Tenant ID: ${result.data.userRecord.tenant_id}
Role ID: ${result.data.userRecord.role_id}`;
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Admin user creation failed:
${error.message}`;
                console.error('Admin user creation test error:', error);
            }
        }

        // Test 5: Complete Onboarding Flow
        async function testCompleteOnboarding() {
            const resultDiv = document.getElementById('completeTestResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'Testing complete onboarding flow...';

            try {
                const timestamp = Date.now();
                const testSubdomain = 'fulltest' + timestamp;

                // Create test data similar to the onboarding form
                const testData = {
                    schoolInfo: {
                        name: 'Full Test School ' + timestamp,
                        type: 'School',
                        subdomain: testSubdomain,
                        address: '456 Full Test Avenue, Test City, TC 54321',
                        contact_phone: '+1-555-999-8888',
                        contact_email: 'contact@fulltest.com',
                        established_year: '2020'
                    },
                    adminUser: {
                        full_name: 'Full Test Admin',
                        email: `fulladmin${timestamp}@fulltest.com`,
                        phone: '+1-555-888-9999',
                        position: 'Principal',
                        password: 'FullTestPassword123!'
                    },
                    settings: {
                        max_students: 1000,
                        max_teachers: 100,
                        max_classes: 50,
                        timezone: 'America/New_York',
                        academic_year_start_month: 9,
                        subscription_plan: 'premium',
                        features: {
                            fees: true,
                            exams: true,
                            messaging: true,
                            attendance: true
                        }
                    }
                };

                // Simulate the complete onboarding process
                const onboardingForm = new SchoolOnboardingForm();
                const result = await onboardingForm.createSchoolWithAdmin(testData);

                if (result.success) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `‚úÖ Complete onboarding flow successful!
School: ${result.tenant.name}
Subdomain: ${result.tenant.subdomain}
Admin Email: ${result.adminEmail}
Login URL: ${result.loginUrl}
Tenant ID: ${result.tenant.id}
Admin User ID: ${result.adminUser.userRecord.id}`;
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Complete onboarding flow failed:
${error.message}`;
                console.error('Complete onboarding test error:', error);
            }
        }

        // Test 6: Multi-tenant Isolation
        async function testMultiTenantIsolation() {
            const resultDiv = document.getElementById('isolationTestResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'Testing multi-tenant isolation...';

            try {
                const supabase = getSupabaseClient();

                // Get all tenants
                const { data: tenants, error: tenantsError } = await supabase
                    .from('tenants')
                    .select('id, name, subdomain');

                if (tenantsError) throw tenantsError;

                if (tenants.length < 2) {
                    resultDiv.className = 'test-result info';
                    resultDiv.textContent = `‚ÑπÔ∏è Need at least 2 tenants to test isolation.
Currently have ${tenants.length} tenant(s).
Create more test tenants to perform isolation testing.`;
                    return;
                }

                // Test isolation by checking users per tenant
                const isolationResults = [];
                
                for (const tenant of tenants) {
                    const { data: users, error: usersError } = await supabase
                        .from('users')
                        .select('id, email, full_name')
                        .eq('tenant_id', tenant.id);

                    if (usersError) {
                        isolationResults.push(`‚ùå Error checking tenant ${tenant.name}: ${usersError.message}`);
                    } else {
                        isolationResults.push(`‚úÖ Tenant "${tenant.name}" (${tenant.subdomain}): ${users.length} user(s)`);
                    }
                }

                resultDiv.className = 'test-result success';
                resultDiv.textContent = `‚úÖ Multi-tenant isolation test completed:

${isolationResults.join('\\n')}

Total tenants: ${tenants.length}
Isolation appears to be working - each tenant has its own users.`;

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Multi-tenant isolation test failed:
${error.message}`;
                console.error('Isolation test error:', error);
            }
        }

        // Clear test data
        async function clearTestData() {
            const resultDiv = document.getElementById('tenantTestResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'Clearing test data...';

            try {
                const supabase = getSupabaseClient();
                let deletedCount = 0;

                // Delete test tenants (this will cascade to related records)
                const { data: testTenants, error: findError } = await supabase
                    .from('tenants')
                    .select('id, name')
                    .or('subdomain.like.%test%,name.like.%Test%');

                if (findError) throw findError;

                for (const tenant of testTenants) {
                    const { error: deleteError } = await supabase
                        .from('tenants')
                        .delete()
                        .eq('id', tenant.id);

                    if (!deleteError) {
                        deletedCount++;
                    }
                }

                resultDiv.className = 'test-result success';
                resultDiv.textContent = `‚úÖ Test data cleared!
Deleted ${deletedCount} test tenant(s).`;
                
                testTenantId = null;
                testAdminUserId = null;

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `‚ùå Failed to clear test data:
${error.message}`;
                console.error('Clear test data error:', error);
            }
        }

        // Initialize test page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('School Onboarding Test Page initialized');
        });
    </script>
</body>
</html>
