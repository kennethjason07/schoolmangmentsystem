<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - School Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 48px 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.1);
            text-align: center;
            animation: cardSlideUp 1.2s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 480px;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes cardSlideUp {
            0% {
                opacity: 0;
                transform: translateY(60px) scale(0.95);
                filter: blur(10px);
            }
            50% {
                opacity: 0.8;
                transform: translateY(20px) scale(0.98);
                filter: blur(2px);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }
        
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .logo {
            width: 96px;
            height: 96px;
            margin: 0 auto 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 900;
            color: white;
            letter-spacing: 2px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            animation: float 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 16px;
        }
        
        .logo::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, #667eea, #764ba2, #667eea);
            border-radius: 22px;
            z-index: -1;
            opacity: 0.7;
            animation: pulse 2s infinite;
        }

        .title {
            font-size: 36px;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 8px;
            line-height: 1.1;
            letter-spacing: -0.5px;
        }
        
        .subtitle-main {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 24px;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 20px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        .description {
            font-size: 16px;
            color: #718096;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 24px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-container {
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0 16px;
            transition: all 0.3s ease;
        }

        .input-container:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-container i {
            color: #667eea;
            margin-right: 12px;
            font-size: 16px;
        }

        .form-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 16px 0;
            font-size: 16px;
            background: transparent;
            color: #2d3748;
        }

        .form-input::placeholder {
            color: #a0aec0;
        }

        .toggle-password {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            transition: color 0.3s ease;
        }

        .toggle-password:hover {
            color: #5a6fd8;
        }

        .password-strength {
            margin-top: 12px;
            font-size: 12px;
        }

        .strength-bar {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .strength-progress {
            height: 100%;
            border-radius: 2px;
            transition: all 0.3s ease;
            width: 0%;
        }

        .strength-weak { color: #e53e3e; }
        .strength-medium { color: #dd6b20; }
        .strength-strong { color: #38a169; }

        .requirements {
            background: #f7fafc;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            text-align: left;
        }

        .requirements h4 {
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .requirements ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .requirements li {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: #718096;
            font-size: 14px;
        }

        .requirements li.valid {
            color: #38a169;
        }

        .requirements li.invalid {
            color: #e53e3e;
        }

        .requirements li i {
            margin-right: 8px;
            width: 16px;
            font-size: 12px;
        }

        .error-message {
            color: #e53e3e;
            font-size: 14px;
            margin-top: 8px;
            display: flex;
            align-items: center;
        }

        .error-message i {
            margin-right: 6px;
        }

        .success-message {
            color: #38a169;
            font-size: 14px;
            margin-top: 8px;
            display: flex;
            align-items: center;
        }

        .success-message i {
            margin-right: 6px;
        }

        .reset-button {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
        }

        .reset-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .reset-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-link {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
        }

        .back-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            font-size: 16px;
        }

        .back-link a:hover {
            color: #5a6fd8;
        }

        .success-card {
            display: none;
            text-align: center;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .success-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 32px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 54px;
            color: white;
            animation: successBounce 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 15px 35px rgba(72, 187, 120, 0.4);
            position: relative;
        }
        
        .success-icon::after {
            content: '';
            position: absolute;
            inset: -4px;
            background: linear-gradient(135deg, #48bb78, #38a169, #48bb78);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }

        @keyframes successBounce {
            0% {
                opacity: 0;
                transform: scale(0.3) rotate(-180deg);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1) rotate(-90deg);
            }
            70% {
                transform: scale(0.95) rotate(0deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .success-title {
            font-size: 32px;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 16px;
            margin-top: 24px;
        }

        .success-subtitle {
            font-size: 18px;
            color: #4a5568;
            margin-bottom: 32px;
            line-height: 1.6;
            font-weight: 500;
        }

        .redirect-message {
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            border: 1px solid #c6f6d5;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 32px;
            color: #22543d;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(34, 84, 61, 0.1);
            animation: fadeInUp 0.8s ease-out 0.5s both;
        }
        
        .account-setup {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            text-align: center;
            border: 1px solid #e2e8f0;
            animation: fadeInUp 0.8s ease-out 0.7s both;
        }
        
        .setup-title {
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.2px;
        }
        
        .setup-description {
            color: #4a5568;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        .support-text {
            color: #718096;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .support-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        
        .support-link:hover {
            color: #5a6fd8;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 640px) {
            .container {
                padding: 16px;
            }
            
            .card {
                padding: 32px 24px;
                border-radius: 16px;
            }
            
            .title {
                font-size: 28px;
            }
            
            .subtitle {
                font-size: 16px;
            }
            
            .logo {
                width: 64px;
                height: 64px;
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .success-icon {
                width: 80px;
                height: 80px;
                font-size: 36px;
                margin-bottom: 20px;
            }
            
            .success-title {
                font-size: 28px;
            }
            
            .success-subtitle {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <!-- Reset Password Form -->
            <div id="resetForm">
                <div class="logo" id="logoContainer">M</div>
                <h1 class="title">MAXIMUS</h1>
                <h2 class="subtitle-main">School Management System</h2>
                <p class="subtitle">Reset Your Password</p>
                <p class="description">Enter your new password below to reset your account.</p>

                <form id="passwordResetForm">
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <div class="input-container">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="newPassword" class="form-input" placeholder="Enter your new password" required>
                            <button type="button" class="toggle-password" onclick="togglePassword('newPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="passwordError" class="error-message" style="display: none;"></div>
                        <div class="password-strength" id="passwordStrength" style="display: none;">
                            <div class="strength-text"></div>
                            <div class="strength-bar">
                                <div class="strength-progress"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <div class="input-container">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm your new password" required>
                            <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="confirmError" class="error-message" style="display: none;"></div>
                        <div id="confirmSuccess" class="success-message" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            Passwords match
                        </div>
                    </div>

                    <!-- Password Requirements -->
                    <div class="requirements">
                        <h4>Password Requirements:</h4>
                        <ul id="requirements">
                            <li id="req-length"><i class="fas fa-times"></i> At least 6 characters</li>
                        </ul>
                    </div>

                    <button type="submit" class="reset-button" id="resetButton">
                        <i class="fas fa-key"></i>
                        Reset Password
                    </button>
                </form>

                <div class="back-link">
                    <a href="javascript:void(0)" onclick="goBackToLogin()">
                        <i class="fas fa-arrow-left"></i> Back to Login
                    </a>
                </div>
            </div>

            <!-- Success Message -->
            <div id="successCard" class="success-card">
                <div class="success-icon">
                    <i class="fas fa-check"></i>
                </div>
                <h1 class="title">MAXIMUS</h1>
                <h2 class="subtitle-main">School Management System</h2>
                <h3 class="success-title">Password Updated!</h3>
                <p class="success-subtitle">Your password has been successfully updated. 🎉<br>Welcome to the school management system!</p>
                
                <div class="redirect-message">
                    <i class="fas fa-sync-alt fa-spin"></i>
                    Redirecting to login page...
                </div>

                <div class="account-setup">
                    <h4 class="setup-title">Account Type</h4>
                    <p class="setup-description">Your account has been set up successfully.</p>
                    <p class="support-text">Need help? <a href="#" class="support-link">Contact Support</a></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://dmagnsbdjsnzsddxqrwd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYWduc2JkanNuenNkZHhxcndkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NTQ2MTEsImV4cCI6MjA2ODIzMDYxMX0.VAo64FAcg1Mo4qA22FWwC7Kdq6AAiLTNeBOjFB9XTi8';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let resetToken = null;
        let refreshToken = null;
        let authSession = null;
        let isResetting = false;
        let tokenValidated = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Password Reset Page Initialized');
            extractAndValidateTokens();
            setupEventListeners();
            loadLogo();
        });

        // Advanced token extraction and validation
        async function extractAndValidateTokens() {
            console.log('🔍 Extracting tokens from URL...');
            console.log('Full URL:', window.location.href);
            
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            
            // Extract all possible token formats
            const tokens = {
                access_token: hashParams.get('access_token') || urlParams.get('access_token'),
                refresh_token: hashParams.get('refresh_token') || urlParams.get('refresh_token'),
                token: hashParams.get('token') || urlParams.get('token'),
                confirmation_token: hashParams.get('confirmation_token') || urlParams.get('confirmation_token'),
                recovery_token: hashParams.get('recovery_token') || urlParams.get('recovery_token'),
                type: hashParams.get('type') || urlParams.get('type')
            };
            
            console.log('📋 Extracted tokens:', {
                access_token: tokens.access_token ? '✓ Found' : '✗ Missing',
                refresh_token: tokens.refresh_token ? '✓ Found' : '✗ Missing',
                token: tokens.token ? '✓ Found' : '✗ Missing',
                type: tokens.type || 'Not specified'
            });
            
            // Determine the primary reset token
            resetToken = tokens.access_token || tokens.token || tokens.recovery_token || tokens.confirmation_token;
            refreshToken = tokens.refresh_token;
            
            if (resetToken) {
                console.log('✅ Reset token found, validating with Supabase...');
                await validateTokenWithSupabase(resetToken, refreshToken);
            } else {
                console.log('⚠️ No reset token found - allowing manual testing');
                showTokenMissingWarning();
            }
        }
        
        // Validate token with Supabase
        async function validateTokenWithSupabase(accessToken, refreshToken) {
            try {
                console.log('🔐 Validating tokens with Supabase...');
                
                // Set the session with the provided tokens
                const { data, error } = await supabaseClient.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken
                });
                
                if (error) {
                    console.error('❌ Token validation failed:', error);
                    handleTokenValidationError(error);
                    return;
                }
                
                if (data.session) {
                    console.log('✅ Token validation successful!');
                    authSession = data.session;
                    tokenValidated = true;
                    showTokenValidatedSuccess();
                } else {
                    console.warn('⚠️ No session created from tokens');
                    showTokenMissingWarning();
                }
                
            } catch (error) {
                console.error('💥 Token validation error:', error);
                handleTokenValidationError(error);
            }
        }
        
        // Handle token validation errors
        function handleTokenValidationError(error) {
            const errorMessage = error.message || 'Unknown error';
            
            if (errorMessage.includes('expired') || errorMessage.includes('invalid')) {
                showError('🔗 This password reset link has expired or is invalid. Please request a new password reset email.');
                setTimeout(() => {
                    goBackToLogin();
                }, 5000);
            } else {
                showError(`Token validation failed: ${errorMessage}. You can still try to reset your password.`);
            }
        }
        
        // Show token missing warning (for testing)
        function showTokenMissingWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
                    border: 1px solid #ffeaa7;
                    border-radius: 12px;
                    padding: 16px;
                    margin-bottom: 24px;
                    color: #856404;
                    font-size: 14px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                ">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Testing Mode:</strong> No reset token found in URL. 
                        <br>You can still test the password reset functionality.
                    </div>
                </div>
            `;
            
            const form = document.getElementById('resetForm');
            form.insertBefore(warningDiv, form.querySelector('form'));
        }
        
        // Show token validation success
        function showTokenValidatedSuccess() {
            const successDiv = document.createElement('div');
            successDiv.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #d4edda, #c3e6cb);
                    border: 1px solid #c3e6cb;
                    border-radius: 12px;
                    padding: 16px;
                    margin-bottom: 24px;
                    color: #155724;
                    font-size: 14px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                ">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Reset Link Verified!</strong> You can now set your new password.
                    </div>
                </div>
            `;
            
            const form = document.getElementById('resetForm');
            form.insertBefore(successDiv, form.querySelector('form'));
        }

        // Setup event listeners
        function setupEventListeners() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const form = document.getElementById('passwordResetForm');

            newPasswordInput.addEventListener('input', function() {
                checkPasswordStrength(this.value);
                validatePasswordRequirements(this.value);
            });

            confirmPasswordInput.addEventListener('input', function() {
                validatePasswordMatch();
            });

            form.addEventListener('submit', handlePasswordReset);
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Check password strength (simplified)
        function checkPasswordStrength(password) {
            const strengthContainer = document.getElementById('passwordStrength');
            const strengthText = strengthContainer.querySelector('.strength-text');
            const strengthProgress = strengthContainer.querySelector('.strength-progress');

            if (!password) {
                strengthContainer.style.display = 'none';
                return;
            }

            strengthContainer.style.display = 'block';

            let feedback = '';
            let progress = 0;

            // Simple length-based strength
            if (password.length < 6) {
                feedback = 'Too Short';
                strengthText.className = 'strength-text strength-weak';
                strengthProgress.style.backgroundColor = '#e53e3e';
                progress = 25;
            } else if (password.length < 10) {
                feedback = 'Good';
                strengthText.className = 'strength-text strength-medium';
                strengthProgress.style.backgroundColor = '#dd6b20';
                progress = 75;
            } else {
                feedback = 'Strong';
                strengthText.className = 'strength-text strength-strong';
                strengthProgress.style.backgroundColor = '#38a169';
                progress = 100;
            }

            strengthText.textContent = `Password: ${feedback}`;
            strengthProgress.style.width = `${progress}%`;
        }

        // Validate password requirements (simplified)
        function validatePasswordRequirements(password) {
            const requirements = {
                'req-length': password.length >= 6
            };

            for (const [reqId, isValid] of Object.entries(requirements)) {
                const element = document.getElementById(reqId);
                const icon = element.querySelector('i');
                
                if (isValid) {
                    element.classList.add('valid');
                    element.classList.remove('invalid');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-check');
                } else {
                    element.classList.add('invalid');
                    element.classList.remove('valid');
                    icon.classList.remove('fa-check');
                    icon.classList.add('fa-times');
                }
            }

            return Object.values(requirements).every(req => req);
        }

        // Validate password match
        function validatePasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorElement = document.getElementById('confirmError');
            const successElement = document.getElementById('confirmSuccess');

            if (!confirmPassword) {
                errorElement.style.display = 'none';
                successElement.style.display = 'none';
                return false;
            }

            if (newPassword !== confirmPassword) {
                errorElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Passwords do not match';
                errorElement.style.display = 'block';
                successElement.style.display = 'none';
                return false;
            } else {
                errorElement.style.display = 'none';
                successElement.style.display = 'block';
                return true;
            }
        }

        // Handle password reset
        async function handlePasswordReset(event) {
            event.preventDefault();
            
            if (isResetting) return;

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            console.log('🔐 Starting password reset process...');

            // Validate inputs
            if (!validatePasswordRequirements(newPassword)) {
                showError('Please ensure your password meets all requirements.');
                return;
            }

            if (!validatePasswordMatch()) {
                showError('Passwords do not match.');
                return;
            }

            // Start loading
            isResetting = true;
            const resetButton = document.getElementById('resetButton');
            resetButton.disabled = true;
            resetButton.innerHTML = '<div class="loading-spinner"></div> Updating Password...';

            try {
                let resetSuccess = false;
                
                // If we have a validated session, use it
                if (tokenValidated && authSession) {
                    console.log('✨ Using validated session for password reset...');
                    
                    const { data, error } = await supabaseClient.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) {
                        console.error('❌ Supabase password update failed:', error);
                        throw error;
                    }
                    
                    console.log('✅ Password updated successfully with Supabase!');
                    resetSuccess = true;
                    
                } else if (resetToken) {
                    console.log('🔑 Attempting password reset with token...');
                    
                    // Try to use the raw token for password reset
                    const { data, error } = await supabaseClient.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) {
                        console.error('❌ Token-based reset failed:', error);
                        // If token method fails, show appropriate error
                        if (error.message.includes('session') || error.message.includes('token')) {
                            throw new Error('Reset link has expired or is invalid. Please request a new password reset email.');
                        }
                        throw error;
                    }
                    
                    console.log('✅ Password reset successful!');
                    resetSuccess = true;
                    
                } else {
                    console.log('🧪 Testing mode: Simulating password reset...');
                    // For testing without token, simulate success
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    resetSuccess = true;
                }
                
                if (resetSuccess) {
                    console.log('✨ Password reset completed successfully!');
                    showSuccess();
                    
                    // Clear sensitive data
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    resetToken = null;
                    authSession = null;
                }

            } catch (error) {
                console.error('💥 Password reset error:', error);
                let errorMessage = 'Failed to reset password. ';
                
                const errorMsg = error.message || 'Unknown error';
                
                if (errorMsg.includes('expired') || errorMsg.includes('invalid')) {
                    errorMessage = '🔗 The reset link has expired or is invalid. Please request a new password reset email.';
                    // Auto-redirect after error
                    setTimeout(() => {
                        console.log('🔄 Redirecting to login due to expired token...');
                        goBackToLogin();
                    }, 5000);
                } else if (errorMsg.includes('same password') || errorMsg.includes('identical')) {
                    errorMessage = '🔁 Please choose a different password from your current one.';
                } else if (errorMsg.includes('weak') || errorMsg.includes('strength')) {
                    errorMessage = '💪 Please choose a stronger password.';
                } else if (errorMsg.includes('session') || errorMsg.includes('unauthorized')) {
                    errorMessage = '🔐 Session expired. Please request a new password reset link.';
                } else {
                    errorMessage += errorMsg;
                }
                
                showError(errorMessage);
            } finally {
                isResetting = false;
                resetButton.disabled = false;
                resetButton.innerHTML = '<i class="fas fa-key"></i> Reset Password';
            }
        }

        // Show success message and redirect
        function showSuccess() {
            document.getElementById('resetForm').style.display = 'none';
            document.getElementById('successCard').style.display = 'block';
            
            // Auto-redirect after 3 seconds
            setTimeout(() => {
                goBackToLogin();
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('passwordError');
            errorElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            errorElement.style.display = 'block';
            
            // Scroll to top to show error
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Smart redirection to login
        function goBackToLogin() {
            console.log('🌍 Initiating smart redirection to login...');
            
            // Clear any auth session
            if (authSession || resetToken) {
                console.log('🧹 Clearing authentication session...');
                supabaseClient.auth.signOut().catch(err => console.log('Signout error:', err));
                authSession = null;
                resetToken = null;
            }
            
            // Try multiple redirection methods for maximum compatibility
            try {
                // Method 1: React Native WebView postMessage
                if (window.ReactNativeWebView) {
                    console.log('📱 Detected React Native WebView - using postMessage');
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'navigate',
                        route: 'Login',
                        action: 'password_reset_complete'
                    }));
                    return;
                }
                
                // Method 2: Check for parent window (iframe/popup)
                if (window.parent && window.parent !== window) {
                    console.log('🖼️ Detected iframe/popup - posting to parent');
                    window.parent.postMessage({
                        type: 'password_reset_complete',
                        action: 'redirect_to_login'
                    }, '*');
                    return;
                }
                
                // Method 3: Smart URL-based redirection
                let redirectUrl;
                const currentUrl = window.location.href;
                
                // Check if we're in development or production
                if (currentUrl.includes('localhost') || currentUrl.includes('127.0.0.1')) {
                    console.log('🛠️ Development environment detected');
                    redirectUrl = 'http://localhost:3000';
                } else if (currentUrl.includes('expo') || currentUrl.includes('snack')) {
                    console.log('🚀 Expo environment detected');
                    // For Expo apps, try to redirect to the main app
                    redirectUrl = window.location.origin;
                } else {
                    console.log('🌍 Production environment detected');
                    redirectUrl = window.location.origin;
                }
                
                // Method 4: History manipulation (if available)
                if (window.history && window.history.length > 1) {
                    console.log('⬅️ Using history.back()');
                    window.history.back();
                    
                    // Fallback after 2 seconds
                    setTimeout(() => {
                        console.log('🔄 History.back() fallback - redirecting to origin');
                        window.location.href = redirectUrl;
                    }, 2000);
                } else {
                    // Direct redirection
                    console.log(`➡️ Direct redirection to: ${redirectUrl}`);
                    window.location.href = redirectUrl;
                }
                
            } catch (error) {
                console.error('❌ Redirection error:', error);
                // Final fallback
                console.log('🆘 Final fallback - redirecting to origin');
                window.location.href = window.location.origin;
            }
        }

        // Load logo - exactly like email verification page
        function loadLogo() {
            const logoContainer = document.getElementById('logoContainer');
            
            console.log('Trying logo path: assets/maximuslogo.jpg');
            
            // Try to load the MAXIMUS logo image first
            const logoImg = new Image();
            logoImg.onload = function() {
                console.log('Logo loaded successfully');
                logoContainer.innerHTML = `<img src="${logoImg.src}" alt="MAXIMUS Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;">`;
            };
            logoImg.onerror = function() {
                console.log('Logo failed to load, trying alternative paths');
                // Try alternative paths
                tryAlternativeLogo(logoContainer);
            };
            
            // Set the primary logo path (same as email verification page)
            logoImg.src = 'assets/maximuslogo.jpg';
        }
        
        function tryAlternativeLogo(logoContainer) {
            const alternativePaths = [
                'maximuslogo.png',
                'maximuslogo.jpg',
                '../assets/logo-white.png',
                '../assets/maximuslogo.jpg',
                './maximuslogo.png',
                './maximuslogo.jpg'
            ];
            
            let pathIndex = 0;
            
            function tryNextPath() {
                if (pathIndex < alternativePaths.length) {
                    const logoImg = new Image();
                    logoImg.onload = function() {
                        console.log(`Alternative logo loaded: ${alternativePaths[pathIndex]}`);
                        logoContainer.innerHTML = `<img src="${logoImg.src}" alt="MAXIMUS Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;">`;
                    };
                    logoImg.onerror = function() {
                        pathIndex++;
                        tryNextPath();
                    };
                    logoImg.src = alternativePaths[pathIndex];
                } else {
                    // All paths failed, use text fallback
                    console.log('All logo paths failed, using text fallback');
                    logoContainer.innerHTML = `
                        <div style="
                            width: 100%; 
                            height: 100%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 36px; 
                            font-weight: 900; 
                            color: white; 
                            letter-spacing: 2px;
                        ">M</div>
                    `;
                }
            }
            
            tryNextPath();
        }
    </script>
</body>
</html>